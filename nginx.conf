events {
    worker_connections 1024;
}

http {
    # ====================================
    # UPSTREAM DEFINITIONS (Load Balancers)
    # ====================================

    # Genre Service Load Balancer
    upstream genre-service {
        least_conn;
        server genre-service:8080 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Book Service Load Balancer
    upstream book-service {
        least_conn;
        server book-service:8083 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Author Service Load Balancer
    upstream author-service {
        least_conn;
        server author-service:8082 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Saga Orchestrator Load Balancer
    upstream saga-orchestrator {
        least_conn;
        server saga-orchestrator:8084 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # ====================================
    # GENRE SERVICE (Port 8080)
    # ====================================
    server {
        listen 8080;
        server_name localhost;

        location / {
            proxy_pass http://genre-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Health check
            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        }
    }

    # ====================================
    # BOOK SERVICE (Port 8081 externally, 8083 internally)
    # ====================================
    server {
        listen 8081;
        server_name localhost;

        location / {
            proxy_pass http://book-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        }
    }

    # ====================================
    # AUTHOR SERVICE (Port 8082)
    # ====================================
    server {
        listen 8082;
        server_name localhost;

        location / {
            proxy_pass http://author-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        }
    }

    # ====================================
    # SAGA ORCHESTRATOR (Port 8084)
    # ====================================
    server {
        listen 8084;
        server_name localhost;

        location / {
            proxy_pass http://saga-orchestrator;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        }
    }

    # ====================================
    # UNIFIED API GATEWAY (Port 80)
    # ====================================
    server {
        listen 80;
        server_name localhost;

        # Genre Service routes
        location /api/genres {
            proxy_pass http://genre-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Book Service routes
        location /api/books {
            proxy_pass http://book-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Author Service routes
        location /api/authors {
            proxy_pass http://author-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Saga Orchestrator routes
        location /api/catalog {
            proxy_pass http://saga-orchestrator;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}